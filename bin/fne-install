#!/usr/bin/env php
<?php

/**
 * Script d'installation interactive pour PHP natif
 *
 * Ce script permet d'installer et configurer le package FNE Client
 * dans un projet PHP natif (sans framework).
 *
 * Usage: php vendor/bin/fne-install
 */

require __DIR__ . '/../vendor/autoload.php';

use function Laravel\Prompts\text;
use function Laravel\Prompts\select;
use function Laravel\Prompts\confirm;
use function Laravel\Prompts\note;
use function Laravel\Prompts\error;
use Neocode\FNE\Install\FrameworkDetector;
use Neocode\FNE\Install\FrameworkType;

// VÃ©rifier que nous sommes bien dans un projet PHP natif
$detector = new FrameworkDetector();
$framework = $detector->detect();

if ($framework !== FrameworkType::PHP) {
    error("âš ï¸  Ce script est uniquement pour les projets PHP natif.");
    error("Framework dÃ©tectÃ© : {$framework->getDescription()}");
    error("Utilisez la commande appropriÃ©e : {$framework->getInstallCommand()}");
    exit(1);
}

echo PHP_EOL;
note('ðŸš€ Installation du package FNE Client', 'PHP natif');
echo PHP_EOL;

// 1. Configuration de l'API
echo "Configuration de l'API FNE" . PHP_EOL;
echo str_repeat('â”€', 50) . PHP_EOL;

$apiKey = text(
    label: 'ClÃ© API FNE',
    placeholder: 'Entrez votre clÃ© API',
    required: true,
    validate: fn($value) => empty(trim($value)) ? 'La clÃ© API est requise' : null
);

$baseUrlChoice = select(
    label: 'URL de l\'API FNE',
    options: [
        'test' => 'Test : http://54.247.95.108/ws',
        'production' => 'Production : (Ã  configurer aprÃ¨s validation DGI)',
        'custom' => 'URL personnalisÃ©e',
    ],
    default: 'test'
);

$customUrl = null;
if ($baseUrlChoice === 'custom') {
    $customUrl = text(
        label: 'URL personnalisÃ©e',
        placeholder: 'https://api.fne.example.com/ws',
        required: true,
        validate: fn($value) => empty(trim($value)) ? 'L\'URL est requise' : null
    );
}

$baseUrl = match ($baseUrlChoice) {
    'test' => 'http://54.247.95.108/ws',
    'production' => '',
    'custom' => $customUrl,
    default => 'http://54.247.95.108/ws',
};

$mode = $baseUrlChoice === 'production' ? 'production' : 'test';

// 2. Configuration du cache
echo PHP_EOL;
$useCache = confirm(
    label: 'Activer le cache ?',
    default: true
);

// 3. Configuration des migrations
echo PHP_EOL;
$publishMigrations = confirm(
    label: 'Installer les migrations SQL pour la table fne_certifications ?',
    default: true
);

// 4. GÃ©nÃ©ration du fichier de configuration
echo PHP_EOL;
note('ðŸ“ GÃ©nÃ©ration de la configuration...');

$config = [
    'api_key' => $apiKey,
    'base_url' => $baseUrl,
    'mode' => $mode,
    'timeout' => 30,
    'cache' => [
        'enabled' => $useCache,
        'ttl' => 3600,
    ],
    'locale' => 'fr',
    'features' => [
        'enabled' => true,
        'advanced_mapping' => true,
        'batch_processing' => false,
        'webhooks' => false,
        'queue_jobs' => false,
        'audit_logging' => true,
        'auto_retry' => true,
        'certification_table' => false,
    ],
];

$configPath = getcwd() . '/fne.php';
$configContent = "<?php\n\n/**\n * Configuration FNE Client\n *\n * Ce fichier a Ã©tÃ© gÃ©nÃ©rÃ© automatiquement par le script d'installation.\n * Vous pouvez le modifier selon vos besoins.\n */\n\nreturn " . var_export($config, true) . ";\n";

if (file_put_contents($configPath, $configContent) === false) {
    error("âŒ Impossible d'Ã©crire le fichier de configuration : {$configPath}");
    exit(1);
}

note("âœ… Configuration crÃ©Ã©e dans : {$configPath}");

// 5. Installation des migrations SQL
if ($publishMigrations) {
    echo PHP_EOL;
    note('ðŸ“ Installation des migrations SQL...');

    $sqlFile = __DIR__ . '/../database/migrations/fne_certifications.sql';
    $targetDir = getcwd() . '/database';
    $targetPath = $targetDir . '/fne_certifications.sql';

    // CrÃ©er le dossier database s'il n'existe pas
    if (!is_dir($targetDir)) {
        if (!mkdir($targetDir, 0755, true)) {
            error("âŒ Impossible de crÃ©er le dossier : {$targetDir}");
            exit(1);
        }
    }

    // Copier le fichier SQL
    if (!file_exists($sqlFile)) {
        error("âŒ Fichier de migration introuvable : {$sqlFile}");
        exit(1);
    }

    if (copy($sqlFile, $targetPath) === false) {
            error("âŒ Impossible de copier le fichier de migration vers : {$targetPath}");
        exit(1);
    }

    note("âœ… Migration SQL copiÃ©e dans : {$targetPath}");
    note("ðŸ’¡ ExÃ©cutez cette migration dans votre base de donnÃ©es pour crÃ©er la table fne_certifications.");
}

// 6. RÃ©sumÃ© de l'installation
echo PHP_EOL;
note('âœ… Installation terminÃ©e avec succÃ¨s !');
echo PHP_EOL;

echo "ðŸ“š Documentation : https://docs.neocode.com/fne-client" . PHP_EOL;
echo PHP_EOL;
echo "ðŸ’¡ Exemple d'utilisation :" . PHP_EOL;
echo PHP_EOL;
echo "   require_once 'vendor/autoload.php';" . PHP_EOL;
echo "   require_once 'fne.php';" . PHP_EOL;
echo PHP_EOL;
echo "   use Neocode\\FNE\\FNEClient;" . PHP_EOL;
echo "   use Neocode\\FNE\\Config\\FNEConfig;" . PHP_EOL;
echo "   use Neocode\\FNE\\Http\\HttpClientFactory;" . PHP_EOL;
echo PHP_EOL;
echo "   \$config = new FNEConfig(require 'fne.php');" . PHP_EOL;
echo "   \$httpClient = HttpClientFactory::create(\$config);" . PHP_EOL;
echo "   \$fne = new FNEClient(\$httpClient, \$config);" . PHP_EOL;
echo PHP_EOL;
echo "   \$result = \$fne->invoice()->sign(\$data);" . PHP_EOL;
echo PHP_EOL;

exit(0);

